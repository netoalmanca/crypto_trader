{% extends "core/base.html" %}
{% load i18n %}

{% block content %}
<div class="max-w-xl mx-auto mt-4 sm:mt-8 bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl">
    <h2 class="text-2xl sm:text-3xl font-bold text-center text-blue-400 mb-6 sm:mb-8">{{ page_title }}</h2>
    
    <div x-data="{ isTestnet: document.getElementById('{{ form.use_testnet.id_for_label }}') ? document.getElementById('{{ form.use_testnet.id_for_label }}').checked : true }"
        class="text-sm p-4 rounded-md mb-6 border transition-all duration-300"
        :class="{ 'bg-yellow-700/30 border-yellow-500/50 text-yellow-300': isTestnet, 'bg-red-700/40 border-red-500/60 text-red-200 font-bold animate-pulse': !isTestnet }">
        <strong x-text="isTestnet ? 'Ambiente de Teste (Testnet) Ativo' : 'ALERTA: Ambiente Real (Mainnet) Ativo'"></strong>
        <p class="mt-1" x-text="isTestnet ? 'As operações usarão a Testnet da Binance (sem fundos reais).' : 'As operações usarão sua conta REAL da Binance. Tenha certeza absoluta do que está fazendo.'"></p>
    </div>

    <form method="post" novalidate id="apiKeysForm">
        {% csrf_token %}
        <div class="space-y-6">
            <div>
                <label for="{{ form.binance_api_key.id_for_label }}" class="form-label">{{ form.binance_api_key.label_tag }}</label>
                {{ form.binance_api_key }}
            </div>
            <div>
                <label for="{{ form.binance_api_secret.id_for_label }}" class="form-label">{{ form.binance_api_secret.label_tag }}</label>
                {{ form.binance_api_secret }}
            </div>
            <hr class="border-gray-600">
            <div>
                <label for="{{ form.preferred_fiat_currency.id_for_label }}" class="form-label">{{ form.preferred_fiat_currency.label_tag }}</label>
                {{ form.preferred_fiat_currency }}
            </div>
            <div class="relative flex items-start pt-4">
                <div class="flex h-6 items-center">
                    <input @change="isTestnet = $event.target.checked" id="{{ form.use_testnet.id_for_label }}" name="{{ form.use_testnet.html_name }}" type="checkbox" {% if form.instance.use_testnet %}checked{% endif %} class="h-5 w-5 rounded border-gray-500 bg-gray-700 text-cyan-600 focus:ring-cyan-500">
                </div>
                <div class="ml-3 text-sm leading-6">
                    <label for="{{ form.use_testnet.id_for_label }}" class="font-medium text-gray-200">{{ form.use_testnet.label }}</label>
                    <p class="text-gray-400">{{ form.use_testnet.help_text|safe }}</p>
                </div>
            </div>
        </div>
        <div class="mt-8">
            <button type="submit" class="btn-primary w-full">
                <div class="spinner"></div>
                <span class="btn-text">Salvar Configurações</span>
            </button>
        </div>
    </form>
    
    <!-- Seção de Ações Perigosas -->
    <div class="mt-10 pt-6 border-t border-red-500/30">
        <h3 class="text-lg font-semibold text-red-400">Zona de Perigo</h3>
        <p class="mt-1 text-sm text-gray-400">Use as ações abaixo se notar inconsistências nos seus dados de portfólio.</p>
        <div class="mt-4 space-y-4">
            <a href="{% url 'core:recalculate_holdings' %}" 
               class="btn-primary w-full bg-orange-700 hover:bg-orange-600"
               onclick="return confirmAndLoad(this, 'Isso irá apagar e reconstruir suas posses locais a partir do seu histórico de transações. É útil para corrigir saldos incorretos. Deseja continuar?')">
                <div class="spinner"></div>
                <span class="btn-text">Recalcular Portfólio</span>
            </a>
            <a href="{% url 'core:reset_portfolio' %}" 
               class="btn-primary w-full bg-red-800 hover:bg-red-700"
               onclick="return confirmAndLoad(this, 'ATENÇÃO!\\n\\nIsso apagará TODAS as suas transações e posses salvas neste aplicativo. Seus fundos na Binance NÃO serão afetados.\\n\\nEsta ação não pode ser desfeita. Deseja continuar?')">
                <div class="spinner"></div>
                <span class="btn-text">Zerar TODOS os Dados Locais</span>
            </a>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Spinner para o formulário principal
    const form = document.getElementById('apiKeysForm');
    if (form) {
        form.addEventListener('submit', function() {
            const submitButton = form.querySelector('button[type="submit"]');
            const buttonText = submitButton.querySelector('.btn-text');
            submitButton.classList.add('loading');
            submitButton.disabled = true;
            if (buttonText) buttonText.textContent = 'Salvando...';
        });
    }
});

// Função reutilizável para botões de âncora na Zona de Perigo
function confirmAndLoad(element, message) {
    if (confirm(message)) {
        const buttonText = element.querySelector('.btn-text');
        element.classList.add('loading');
        element.style.pointerEvents = 'none'; // Desabilita o link
        if (buttonText) buttonText.textContent = 'Processando...';
        return true; // Permite que o link seja seguido
    }
    return false; // Impede a navegação se o usuário cancelar
}
</script>
{% endblock %}

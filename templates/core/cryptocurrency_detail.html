{% extends "core/base.html" %}
{% load i18n %}
{% load humanize %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Cabeçalho com o Nome e Preço -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div class="flex items-center mb-4 sm:mb-0">
                {% if crypto.logo_url %}
                    <img src="{{ crypto.logo_url }}" class="h-12 w-12 mr-4 rounded-full" alt="Logo de {{ crypto.name }}">
                {% endif %}
                <div>
                    <h1 class="text-3xl font-bold text-white">{{ crypto.name }} ({{ crypto.symbol }})</h1>
                    <p class="text-gray-400">Moeda de Cotação para Preço: {{ crypto.price_currency }}</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-4xl font-extrabold text-cyan-400">
                    {{ crypto.current_price|floatformat:crypto.get_price_decimals|intcomma }}
                    <span class="text-2xl text-gray-500">{{ crypto.price_currency }}</span>
                </p>
                <p class="text-sm text-gray-500">Última atualização: {{ crypto.last_updated|date:"d/m/Y H:i" }}</p>
            </div>
        </div>

        <!-- Card do Gráfico -->
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Histórico de Preços (Últimos 90 dias - Fechamento Diário)</h2>
            {% if not chart_error_message %}
                <canvas id="priceChart"></canvas>
            {% else %}
                <div class="bg-red-900/50 border border-red-500 text-red-300 px-4 py-3 rounded-lg">
                    <p>{{ chart_error_message }}</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chartDataElement = document.getElementById('priceChart');
        if (chartDataElement) {
            const ctx = chartDataElement.getContext('2d');
            let chartData;

            try {
                // Tenta analisar os dados JSON passados pela view
                chartData = JSON.parse('{{ klines_data_json|escapejs }}');
            } catch (e) {
                console.error("Erro ao analisar os dados do gráfico:", e);
                // Exibe uma mensagem de erro no lugar do gráfico se os dados forem inválidos
                const errorContainer = chartDataElement.parentElement;
                errorContainer.innerHTML = `<div class="bg-red-900/50 border border-red-500 text-red-300 px-4 py-3 rounded-lg"><p>Não foi possível carregar os dados para o gráfico.</p></div>`;
                return;
            }

            if (chartData && chartData.labels && chartData.data) {
                // Gradiente para a linha do gráfico
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(6, 182, 212, 0.8)');
                gradient.addColorStop(1, 'rgba(6, 182, 212, 0.1)');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: `Preço de Fechamento (${chartData.currency})`,
                            data: chartData.data,
                            borderColor: '#06b6d4',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointBackgroundColor: '#06b6d4',
                            pointRadius: 0, // Pontos aparecem no hover
                            pointHoverRadius: 6,
                            tension: 0.1,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#d1d5db' }
                            },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                titleColor: '#ffffff',
                                bodyColor: '#d1d5db',
                                displayColors: false
                            }
                        }
                    }
                });
            }
        }
    });
</script>
{% endblock %}
